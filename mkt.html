<!-- /mkt.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MKT · 토큰 전용페이지</title>

  <link rel="stylesheet" href="/assets/css/app.css"/>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.14.0/dist/ethers.umd.min.js"></script>

  <!-- ApexCharts (차트) -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <script src="/assets/js/config.js"></script>
  <script src="/assets/js/partials.js"></script>

  <script>
    // /mkt.html
    // 이 페이지는 MKT 전용페이지입니다.
    // tokendetail.js가 URL 파라미터를 읽어서 토큰을 선택하므로, 파라미터가 없으면 자동으로 붙여줍니다.
    (function () {
      try {
        var cfg = window.HEXDAO_CONFIG || {};
        var param = cfg.urlTokenParam || 'token';
        var u = new URL(location.href);
        var cur = (u.searchParams.get(param) || '').toUpperCase();
        if (cur !== 'MKT') {
          u.searchParams.set(param, 'MKT');
          location.replace(u.toString());
        }
      } catch (e) {}
    })();
  </script>
</head>
<body>
  <div class="page">
    <div id="site-header"></div>

    <div class="main-wrap">
      <div class="block-title" id="tokenTitle">MKT 전용페이지</div>
      <div class="block-text">지갑연결해야 아래 정보가 표시됩니다. (구매/환매/스테이킹 실행 시 지갑에서 확인 필요)</div>

      <div class="hr"></div>

      <div class="card">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="btnConnectLocal">지갑연결</button>

          <button class="btn" id="btnAllowance" title="approve 전에 allowance를 먼저 확인하세요">승인상태(allowance) 확인</button>

          <img id="tokenImg" alt="token" style="width:28px;height:28px;border-radius:6px;object-fit:cover;" />

          <div class="mono">Token Symbol: <span id="tokenKeyText">-</span></div>

          <div class="mono" style="margin-left:auto;">내 HEX: <span id="iMyHex">-</span></div>
          <div class="mono">내 USDT: <span id="iMyUsdt">-</span></div>
        </div>

        <!-- allowance 안내/표시 (작게) -->
        <div style="margin-top:8px; font-size:12px; color:var(--muted); line-height:1.35;">
          <div>
            HEX → Bank 승인량: <span class="mono" id="iAllowHex">-</span>
            <span style="margin:0 8px; opacity:.5;">|</span>
            Token → Bank 승인량: <span class="mono" id="iAllowTok">-</span>
          </div>
          <div id="allowanceHint" style="margin-top:4px; opacity:.9;">
            안내: 구매는 HEX 승인, 환매/스테이킹은 Token 승인이 필요합니다. 먼저 “승인상태(allowance) 확인”을 눌러 부족하면 지갑에서 approve를 완료하세요.
          </div>
        </div>

        <div style="margin-top:12px;">
          <div id="myChart" style="width:100%; min-height:120px;"></div>
        </div>

        <div class="info-grid" style="margin-top:10px;">
          <div class="inf"><div class="k">계약HEX잔고</div><div class="v" id="iHEXBAL">-</div></div>
          <div class="inf"><div class="k">계약토큰잔고</div><div class="v" id="iBAL">-</div></div>
          <div class="inf"><div class="k">현재가격ROI</div><div class="v" id="iAprApy">-</div></div>
          <div class="inf"><div class="k">현재가격(HEX/Token)</div><div class="v" id="iPrice">-</div></div>

          <div class="inf"><div class="k">스테이킹(depo)</div><div class="v" id="iDepo">-</div></div>

          <div class="inf"><div class="k">뱅크 전체스테이킹(totalStaked)</div><div class="v" id="iTotalStaked">-</div></div>
          <div class="inf"><div class="k">구매가능 개수(전체/10)</div><div class="v" id="iBuyCap">-</div></div>

          <div class="inf"><div class="k">토큰1개당배당액(7일)</div><div class="v" id="iWeekly">-</div></div>
          <div class="inf"><div class="k">구매개수(totalBuy)</div><div class="v" id="iBought">-</div></div>
          <div class="inf"><div class="k">환매가능개수(참고)</div><div class="v" id="iSellable">-</div></div>
          <div class="inf"><div class="k">이번에배당받을HEX</div><div class="v" id="iallow">-</div></div>
          <div class="inf"><div class="k">언스테이킹까지 남은 시간</div><div class="v" id="iUnstakeLeft">-</div></div>
          <div class="inf"><div class="k">이자배당까지 남은 시간</div><div class="v" id="iClaimLeft">-</div></div>
          <div class="inf"><div class="k">내 토큰 시가총액(HEX)</div><div class="v" id="iMyMcap">-</div></div>
          <div class="inf"><div class="k">내 평균매수가(HEX/Token)</div><div class="v" id="iMyAvg">-</div></div>
          <div class="inf"><div class="k">지금까지수익률(%)</div><div class="v" id="iMyRoiPct">-</div></div>
          <div class="inf"><div class="k">자동스테이크비율</div><div class="v" id="iAutoStakeBps">-</div></div>
          <div class="inf"><div class="k">매도수수료</div><div class="v" id="iSellFee">-</div></div>
        </div>
      </div>

      <div class="form-grid">
        <div class="form-box">
          <div class="swap-top"><div id="lblBuy">토큰 구매(HEX 지불)</div><div class="mono" id="fnBuy">buy</div></div>
          <input class="input" id="inpBuyAmt" placeholder="수량" />
          <button class="swap-btn" id="btnBuy" style="margin-top:10px;">구매</button>
          <div class="tx-flow" id="flowBuy" aria-live="polite">
            <div class="tx-flow__step" id="flowBuyStep">대기</div>
            <div class="tx-flow__msg" id="flowBuyMsg">승인이 필요하면 1/2 승인 → 2/2 구매 순서로 지갑 서명이 두 번 뜹니다.</div>
            <div class="tx-flow__hash" id="flowBuyHash"></div>
          </div>
          <div class="swap-est" id="buyEst">-</div>
        </div>

        <div class="form-box">
          <div class="swap-top"><div id="lblSell">토큰 환매(HEX 받기)</div><div class="mono" id="fnSell">sell</div></div>
          <input class="input" id="inpSellAmt" placeholder="수량" />
          <button class="swap-btn" id="btnSell" style="margin-top:10px;">환매</button>
          <div class="tx-flow" id="flowSell" aria-live="polite">
            <div class="tx-flow__step" id="flowSellStep">대기</div>
            <div class="tx-flow__msg" id="flowSellMsg">승인이 필요하면 1/2 승인 → 2/2 환매 순서로 지갑 서명이 두 번 뜹니다.</div>
            <div class="tx-flow__hash" id="flowSellHash"></div>
          </div>
          <div class="swap-est" id="sellEst">-</div>
        </div>

        <div class="form-box">
          <div class="swap-top"><div>스테이킹</div><div class="mono" id="fnStake">stake</div></div>
          <input class="input" id="inpStakeAmt" placeholder="수량" />
          <button class="swap-btn" id="btnStake" style="margin-top:10px;">스테이킹</button>
          <div class="tx-flow" id="flowStake" aria-live="polite">
            <div class="tx-flow__step" id="flowStakeStep">대기</div>
            <div class="tx-flow__msg" id="flowStakeMsg">승인이 필요하면 1/2 승인 → 2/2 스테이킹 순서로 지갑 서명이 두 번 뜹니다.</div>
            <div class="tx-flow__hash" id="flowStakeHash"></div>
          </div>
          <div class="swap-est" id="stakeResult">-</div>
        </div>

        <div class="form-box">
          <div class="swap-top"><div>이자배당 청구</div><div class="mono" id="fnClaim">claimDividend</div></div>
          <button class="swap-btn" id="btnClaim" style="margin-top:10px;">청구</button>
          <div class="swap-est" id="claimResult">-</div>
        </div>

        <div class="form-box">
          <div class="swap-top"><div>언스테이킹(출금)</div><div class="mono" id="fnWithdraw">withdraw</div></div>
          <button class="swap-btn" id="btnWithdraw" style="margin-top:10px;">출금</button>
          <div class="swap-est" id="withdrawResult">-</div>
        </div>
      </div>

      <div class="status" id="statusTokenDetail">상태: 대기</div>
    </div>

    <div id="site-footer"></div>
  </div>

  <script src="/assets/js/header-stats.js"></script>
  <script src="/assets/js/header-wallet.js"></script>
  <script src="/assets/js/chart.js"></script>
  <script src="/assets/js/tokendetail.js"></script>
</body>
</html>
